<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jam.client.community.dao.CommunityDAO">
	
	<!-- 커뮤니티 검색 -->
	<sql id="comSearch">
		<if test="keyword != null and keyword != ''">
			<![CDATA[
			AND (
				LOWER(c.title) LIKE '%' || LOWER(#{keyword}) || '%' ESCAPE '\'
        		OR LOWER(c.content) LIKE '%' || LOWER(#{keyword}) || '%' ESCAPE '\'
			)
			]]>
		</if>
	</sql>
	
	<select id="getBoard" parameterType="community" resultType="community">
		<![CDATA[
		SELECT c.post_id, c.title, TO_CHAR(c.created_at, 'YYYY/MM/DD HH24:MI') AS created_at, 
	        	c.comment_count, c.view_count, m.user_id, m.user_name, 0 AS isFavorite  
	    FROM community c
	    JOIN member m 
	    ON c.user_id = m.user_id
	    ]]>
	    <where>
        	1=1
        	<include refid="comSearch"></include>
        </where>
	    <![CDATA[
	    ORDER BY post_id DESC
	    OFFSET (#{pageNum} -1) * #{amount} ROWS
	    FETCH NEXT #{amount} ROWS ONLY
	    ]]>
	</select>

	<!-- 로그인 한 사용자는 즐겨찾기 한 글도 함께 조회 -->
	<select id="getBoardWithFavorite" parameterType="community" resultType="community">
		<![CDATA[
		SELECT c.post_id, c.title, TO_CHAR(c.created_at, 'YYYY/MM/DD HH24:MI') AS created_at, 
	        	c.comment_count, c.view_count, m.user_id, m.user_name,
	        	CASE WHEN f.post_id IS NOT NULL THEN 1 ELSE 0 END AS isFavorite 
	    FROM community c
	    JOIN member m ON c.user_id = m.user_id
	    LEFT JOIN favorite f  
			ON c.post_id = f.post_id  
			AND f.board_type = 'community'  
			AND f.user_id = #{user_id, jdbcType=VARCHAR}
	    ]]>
	    <where>
        	1=1
        	<include refid="comSearch"></include>
        </where>
	    <![CDATA[
	    ORDER BY post_id DESC
	    OFFSET (#{pageNum} -1) * #{amount} ROWS
	    FETCH NEXT #{amount} ROWS ONLY
	    ]]>
	</select>
	
	<!-- 커뮤니티 레코드 수 조회 -->
	<select id="listCnt" parameterType="community" resultType="int">
	    SELECT count(*)
	    FROM community c
	    LEFT JOIN member m ON c.user_id = m.user_id
	    <where>
			1=1
		    <include refid="comSearch"></include>
		</where>
	</select>	
	
	<!-- 인기글 -->
	<select id="getPopularBoard" resultType="community">
		<![CDATA[
		SELECT 
			c.post_id, 
			c.title,
			m.user_name, 
			c.comment_count,
			(c.view_count * 1 + c.comment_count * 5) AS popularity_score
		FROM community c
		JOIN member m ON c.user_id = m.user_id
		WHERE c.created_at >= SYSDATE - 14
		ORDER BY popularity_score DESC
		FETCH FIRST 15 ROWS ONLY
		]]>
	</select>
	
	<!-- 커뮤니티 조회수 증가  -->
	<update id="incrementReadCnt" parameterType="Long">
		UPDATE community SET view_count = view_count + 1 where post_id = #{post_id}
	</update>
	
	<!-- 커뮤니티 상세 페이지 -->
	<select id="getPost" resultType="community">
		SELECT c.post_id, c.title, c.content, c.view_count, to_char(c.created_at,'YYYY"년" MM"월" DD"일" HH24:MI') as created_at, m.user_name, c.user_id 
		FROM community c
		LEFT JOIN Member m 
		ON c.user_id = m.user_id
		WHERE post_id = #{post_id}
	</select>
	
	<!-- 커뮤니티 글 작성 -->
	<insert id="writePost" parameterType="community">
		<selectKey keyProperty="post_id" resultType="Long" order="BEFORE">
        	select com_seq.nextval from dual
    	</selectKey>
		INSERT INTO community(post_id, user_id, title, content, view_count, comment_count)
		VALUES(#{post_id},#{user_id}, #{title}, #{content}, 0 ,0)
	</insert>
	
	<!-- 커뮤니티 수정 할 글 불러오기 -->
	<select id="getPostById" parameterType="community"  resultType="community">
		SELECT post_id, title, content, imageFileName
		FROM community
		WHERE post_id = #{post_id} 
	</select>
	
	<!-- 커뮤니티 글 수정 -->
	<update id="editPost" parameterType="community">
		UPDATE community SET
		title = #{title},
		content = #{content},
		created_at = sysdate
		WHERE post_id = #{post_id} AND user_id = #{user_id}
	</update>
	
	<!-- 커뮤니티 글 삭제 -->
	<delete id="deletePost" parameterType="community">
		DELETE FROM community WHERE post_id = #{post_id} AND user_id = #{user_id}
	</delete>
	
	<!-- 댓글 개수 증감 -->
	<update id="updateCommentCnt">
		update community
		set comment_count = comment_count + #{amount}
		where post_id = #{post_id} 
	</update>
	
	<!-- 작성한 커뮤니티 글 조회 --> 
	<select id="getMyPosts" resultType="community" parameterType="community">
		<![CDATA[
		SELECT c.post_id, c.title, TO_CHAR(c.created_at, 'YYYY/MM/DD HH24:MI') AS created_at, 
	        	c.comment_count, c.view_count, m.user_name
	    FROM community c
	    JOIN member m 
	    ON c.user_id = m.user_id
	    ]]>
	    <where>
        	c.user_id  = #{user_id}
        	<include refid="comSearch"></include>
        </where>
	    <![CDATA[
	    ORDER BY c.post_id DESC
	    OFFSET (#{pageNum} -1) * #{amount} ROWS
	    FETCH NEXT #{amount} ROWS ONLY
	    ]]>
	</select>
	
	<!-- 작성한 커뮤니티 레코드 수 조회 -->
	<select id="getMyPostsCnt" parameterType="community" resultType="int">
	    SELECT count(*)
	    FROM community c
	    WHERE user_id = #{user_id}
	    <trim prefix="AND (" suffix=")" prefixOverrides="AND | OR">
	        <include refid="comSearch"></include>
	    </trim>
	</select>
	
	<delete id="deleteMyPosts">
		DELETE FROM community
		WHERE user_id = #{user_id}
		AND post_id IN
		<foreach collection="postIds" item="postId" open="(" separator="," close=")">
			#{postId}
		</foreach>
	</delete>
	
</mapper>