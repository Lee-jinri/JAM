<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{template/client/layout}">
<head>
<meta charset="UTF-8">
<title>ì»¤ë®¤ë‹ˆí‹°</title>
<script th:src="@{/js/community/board.js}"></script>
	<style>
	
	</style>
	<script th:inline="javascript">
		$(function(){
			let postId = $("#postId").val();
			let authorUserName;
					
			getPost(postId);
			getBoard();
			getPopularBoard();
					
			// ìˆ˜ì • ë²„íŠ¼ í´ë¦­
			$(document).on("click", "#comUpdateBtn", function() {
				if(postId == null) alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
				else $(location).attr('href', '/community/post/edit/'+postId);
			});
					
			// ì‚­ì œ ë²„íŠ¼ í´ë¦­
			$(document).on("click", "#comDeleteBtn", function() {
				if(postId == null) alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
				if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){

					fetch('/api/community/post/' + postId, {
						method: 'DELETE'
					})
					.then(response => {
						if (!response.ok) {
							return response.json().then(err => {
						        throw err;
						    });
						}else{
							alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
							$(location).attr('href', '/community/board');
						}				
					})
					.catch(err => {
						if (handleApiError(err)) return;
						alert(err.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
					});
				}
			});
		})
	
		function getPost(postId){
			if(postId == "" || postId == null) alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
			else{
				fetch('/api/community/post/' + postId)
				.then(response => {
					if (!response.ok) {
						return response.json().then(err => {
					        throw err;
					    });
					}
					return response.json();
				})
				.then(data => {
					const detail = data.detail;
				    authorUserName = detail.user_name;
				        
				    $("#com_title").text(detail.title);
					$("#user_name").text(detail.user_name + "ë‹˜");
					$("#user_name").attr("data-userid", detail.user_id);
					$("#created_at").text(detail.created_at);
					$("#view_count").text("ì¡°íšŒ " + detail.view_count);
					$("#com_content").html(detail.content);
					        
					currentUserIsAuthor(data.isAuthor);
				})
				.catch(err => {
					if (handleApiError(err)) return;
					alert(err.detail || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
				});
			}
		}
	
		// í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì™€ ê¸€ì“´ì´ê°€ ê°™ì€ì§€ ë¹„êµí•˜ëŠ” í•¨ìˆ˜
		function currentUserIsAuthor(isAuthor){
			// ê¸€ì“´ì´ì™€ ì‚¬ìš©ìê°€ ê°™ìœ¼ë©´ ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
			if (isAuthor) { 
				var btnDiv = document.getElementById("btn-div");
				
				// ìˆ˜ì • ë²„íŠ¼ ìƒì„±		        
				var updateButton = document.createElement("button");
									        
				updateButton.type = "button";
				updateButton.id = "comUpdateBtn";
				updateButton.classList.add("action-btn");
				updateButton.textContent = "ìˆ˜ì •"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
				
				// ì‚­ì œ ë²„íŠ¼ ìƒì„±
				var deleteButton = document.createElement("button");
				deleteButton.type = "button";
				deleteButton.id = "comDeleteBtn";
				deleteButton.classList.add("action-btn");
				deleteButton.textContent = "ì‚­ì œ"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
					
				btnDiv.appendChild(updateButton);
				btnDiv.appendChild(deleteButton);
			}
		} 
	</script>
</head>
<body>
	<div layout:fragment="body">
		<div class=" my-top-15 my-bottom-15">
			<input type="hidden" id="postId" name="postId" th:value="${postId}" />
			
			<div class="post-container">
				<div class="post-header">
				    <p id="com_title" class="com_title post-title"></p>
				</div>
				<div class="post-info">
					<div class="post-user-profile">
						<i class="fa-solid fa-face-smile" style="font-size: 25px; color: #bbb;"></i>
						<span id="user_name" class="userName font-size-14"></span>  
						<div class="userNameToggle"></div>
					</div>
					<div class="post-meta">
						<span id="created_at" class="font-size-14"></span>
				        <span class="view_count post-view-count">
				            <span id="view_count" class="font-size-14"></span>
				        </span>	
					</div> 
			    </div>
				
				<!-- ë³¸ë¬¸ ì˜ì—­ -->
				<div class="com-content content-div">
				    <p id="com_content"></p>
				</div>
				
				<!-- ë²„íŠ¼ ì˜ì—­ -->
				<div class="post-buttons">
				    <div id="btn-div" class="author-buttons"></div>
				    <a th:href="@{/community/board}" class="board-btn">ëª©ë¡</a>
				</div>
				
				<!-- ëŒ“ê¸€ -->
				<div class="com-reply">
					<div th:replace="~{community/comment :: commentFragment(postId=${postId})}"></div>
				</div>
			</div>	
			
			<div class="board-section">
				<div class="popular-section my-top-7 my-bottom-8">
					<div class="hot-box">
						<div class="hot-label">HOT ğŸ”¥</div>
						
						<ul id="popularList"></ul>
						<div class="popular-pagination text-center my-top-5">
						<button id="prevPopular" class="arrow-btn">
							<i class="fa-solid fa-arrow-left fa-sm"></i>
						</button>
						<button id="nextPopular" class="arrow-btn">
							<i class="fa-solid fa-arrow-right fa-sm"></i>
						</button>
						</div>
					</div>
				</div>
				
				<div class="content">
					<div>
					    <ul style="display:none;">
					        <li id="boardTemplate" class="border-bottom" >
					            <div class="boardLink cursor-pointer pd-2rem flex items-center " >
					                
					                <div class="flex items-center justify-center ml-2 mr-2" style="width: 3rem;">
					                    <span class="favoriteSpan">
					                        <i class="favorite fa-star" style="color: #FFD43B; cursor: pointer;"></i>
					                    </span>
					                </div>
					
					                <div class="title-container flex-1 flex items-center cursor-pointer">
					                    <div class="flex items-center">
					                        <span class="font-size-5 boardTitle"></span>
					                        <span class="ml-05 boardReplyCnt"></span>
					                    </div>
					                </div>
									<div class="userName-div my-bottom-2 flex">
					                    <span class="userName"></span>
					                    <div class="userNameToggle"></div>
					                </div>
					                
					                <div class="date-container flex-1 text-right">
					                    <div class="my-bottom-2">
					                        <span class="boardDate"></span>
					                    </div>
					                    <div class="flex items-center justify-end my-top-2">
					                        <span class="ml-05 boardHits"></span>
					                    </div>
					                </div>
					
					            </div>
					        </li>
					    </ul>
					    
					    <ul id="boardList">
						</ul>
					</div>
					
					<div>
						<!-- í˜ì´ì§• ì˜ì—­ -->
						<div class="text-center my-top-8">
						    <ul id="pagination" class="pagination pagination_border"></ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>